<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>🌱 Experiência AR – Mão Aberta</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

  <style>
    :root { --bg:#f5e4b8; --text:#3b3820; }
    body{ margin:0; overflow:hidden; font-family:'Poppins',sans-serif; background:var(--bg); }
    /* Header padrão */
    .header{
      position:fixed; inset:15px auto auto 50%; transform:translateX(-50%);
      color:var(--text); font-weight:800; font-size:clamp(18px,5vw,22px); z-index:10;
      text-shadow:1px 1px 0 rgba(255,255,255,.6);
    }
    /* Voltar */
    #backBtn{
      position:fixed; top:15px; left:15px; z-index:10;
      width:48px; height:48px; border-radius:50%;
      background:linear-gradient(160deg,#f6d36b,#d5a55a);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 4px 8px rgba(0,0,0,.2); cursor:pointer; transition:.2s;
    }
    #backBtn:hover{ transform:scale(1.05); }
    #backBtn svg{ width:26px; height:26px; stroke:#3b2b1f; stroke-width:2.5; fill:none; }

    /* Feed da câmera (atrás da cena) */
    video{
      position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover;
      z-index:1; /* sem espelhar, pra bater com as coords do iOS/Android traseira */
    }

    /* Cena A-Frame sobre o vídeo */
    a-scene{ position:fixed; inset:0; z-index:2; }

    /* Hint discreto */
    .hint{
      position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.45); color:#fff; padding:6px 10px; border-radius:10px;
      font-size:12px; z-index:10;
    }
  </style>
</head>
<body>
  <div class="header">Experiência AR</div>
  <div id="backBtn" title="Voltar">
    <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
  </div>

  <!-- Vídeo da câmera (traseira) -->
  <video id="inputVideo" autoplay playsinline muted></video>

  <!-- Cena A-Frame -->
  <a-scene embedded vr-mode-ui="enabled:false">
    <a-entity id="cameraRig">
      <a-entity id="cam" camera look-controls position="0 1.6 0"></a-entity>
    </a-entity>

    <!-- Modelo (invisível até detectar mão aberta) -->
    <a-entity id="flower"
      gltf-model="url(assets/florzinha.glb)"
      scale="0.6 0.6 0.6"
      visible="false"
      animation-mixer>
    </a-entity>

    <!-- Luzes básicas -->
    <a-entity light="type:ambient; intensity:1.4; color:#ffffff"></a-entity>
    <a-entity light="type:directional; intensity:1; color:#ffffff" position="0 2 3"></a-entity>
  </a-scene>

  <div class="hint">Abra a mão para aparecer a florzinha 🌸</div>

  <script>
  const video = document.getElementById('inputVideo');
  const modelEl = document.getElementById('flower');
  const camEl = document.getElementById('cam');

  // ---- Detector de mão aberta (heurística leve)
  function isHandOpen(landmarks){
    const FINGERS = [
      {tip:8, pip:6}, {tip:12, pip:10}, {tip:16, pip:14}, {tip:20, pip:18}
    ];
    let extended = 0;
    for(const f of FINGERS){
      if(landmarks[f.tip].y < landmarks[f.pip].y) extended++;
    }
    const dThumb = Math.hypot(
      landmarks[4].x - landmarks[2].x,
      landmarks[4].y - landmarks[2].y
    );
    const thumbOpen = dThumb > 0.08;
    return extended >= 3 && thumbOpen;
  }

  function palmCenter(landmarks){
    const idx = [0,1,5,9,13,17];
    let x=0,y=0;
    idx.forEach(i=>{x+=landmarks[i].x;y+=landmarks[i].y;});
    return {x:x/idx.length, y:y/idx.length};
  }

  function placeAtScreenPoint(nx, ny, distanceMeters=0.6){
    const threeCam = camEl.getObject3D('camera');
    if(!threeCam) return;
    const ndcX = nx*2 - 1;
    const ndcY = -(ny*2 - 1);
    const vec = new THREE.Vector3(ndcX, ndcY, 0.5).unproject(threeCam);
    const dir = vec.sub(threeCam.position).normalize();
    const pos = threeCam.position.clone().add(dir.multiplyScalar(distanceMeters));
    modelEl.object3D.position.copy(pos);
  }

  const hands = new Hands({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.6
  });

  hands.onResults(res=>{
    if(res.multiHandLandmarks && res.multiHandLandmarks.length){
      const lm = res.multiHandLandmarks[0];
      const open = isHandOpen(lm);
      modelEl.setAttribute('visible', open);
      if(open){
        const c = palmCenter(lm);
        placeAtScreenPoint(c.x, c.y);
      }
    }else{
      modelEl.setAttribute('visible', false);
    }
  });

  // 🔹 NOVO: botão manual para ativar câmera traseira
  const btn = document.createElement("button");
  btn.textContent = "Ativar Câmera Traseira 📷";
  btn.style.position = "fixed";
  btn.style.bottom = "15px";
  btn.style.right = "15px";
  btn.style.padding = "10px 16px";
  btn.style.border = "none";
  btn.style.borderRadius = "10px";
  btn.style.background = "linear-gradient(160deg,#f6d36b,#d5a55a)";
  btn.style.color = "#3b2b1f";
  btn.style.fontWeight = "700";
  btn.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
  btn.style.cursor = "pointer";
  btn.style.zIndex = "20";
  document.body.appendChild(btn);

  async function startCamera(back=false){
    try{
      const constraints = back
        ? {video:{facingMode:{exact:'environment'}}, audio:false}
        : {video:true, audio:false};
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();

      const cam = new Camera(video, {
        onFrame: async ()=>{await hands.send({image:video});},
        width:640, height:480
      });
      cam.start();

      console.log('✅ Câmera iniciada', back ? '(traseira)' : '(automática)');
    }catch(err){
      console.error('❌ Erro ao acessar câmera:', err);
      alert("Não foi possível acessar a câmera. Verifique as permissões do navegador.");
    }
  }

  // Botão ativa a traseira
  btn.addEventListener('click', ()=>{
    startCamera(true);
    btn.style.display = "none"; // esconde depois de ativar
  });

  // Voltar
  document.getElementById('backBtn').addEventListener('click', ()=>{ window.location.href='index.html'; });

  // Inicia normal (frontal, se Safari travar)
  startCamera(false);
</script>

</body>
</html>
