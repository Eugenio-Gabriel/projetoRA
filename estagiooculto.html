<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>üå± Experi√™ncia AR ‚Äì M√£o Aberta</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

  <style>
    :root { --bg:#f5e4b8; --text:#3b3820; }
    body{ margin:0; overflow:hidden; font-family:'Poppins',sans-serif; background:var(--bg); }
    /* Header padr√£o */
    .header{
      position:fixed; inset:15px auto auto 50%; transform:translateX(-50%);
      color:var(--text); font-weight:800; font-size:clamp(18px,5vw,22px); z-index:10;
      text-shadow:1px 1px 0 rgba(255,255,255,.6);
    }
    /* Voltar */
    #backBtn{
      position:fixed; top:15px; left:15px; z-index:10;
      width:48px; height:48px; border-radius:50%;
      background:linear-gradient(160deg,#f6d36b,#d5a55a);
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 4px 8px rgba(0,0,0,.2); cursor:pointer; transition:.2s;
    }
    #backBtn:hover{ transform:scale(1.05); }
    #backBtn svg{ width:26px; height:26px; stroke:#3b2b1f; stroke-width:2.5; fill:none; }

    /* Feed da c√¢mera (atr√°s da cena) */
    video{
      position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover;
      z-index:1; /* sem espelhar, pra bater com as coords do iOS/Android traseira */
    }

    /* Cena A-Frame sobre o v√≠deo */
    a-scene{ position:fixed; inset:0; z-index:2; }

    /* Hint discreto */
    .hint{
      position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.45); color:#fff; padding:6px 10px; border-radius:10px;
      font-size:12px; z-index:10;
    }
  </style>
</head>
<body>
  <div class="header">Experi√™ncia AR</div>
  <div id="backBtn" title="Voltar">
    <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
  </div>

  <!-- V√≠deo da c√¢mera (traseira) -->
  <video id="inputVideo" autoplay playsinline muted></video>

  <!-- Cena A-Frame -->
  <a-scene embedded vr-mode-ui="enabled:false">
    <a-entity id="cameraRig">
      <a-entity id="cam" camera look-controls position="0 1.6 0"></a-entity>
    </a-entity>

    <!-- Modelo (invis√≠vel at√© detectar m√£o aberta) -->
    <a-entity id="flower"
      gltf-model="url(assets/florzinha.glb)"
      scale="0.6 0.6 0.6"
      visible="false"
      animation-mixer>
    </a-entity>

    <!-- Luzes b√°sicas -->
    <a-entity light="type:ambient; intensity:1.4; color:#ffffff"></a-entity>
    <a-entity light="type:directional; intensity:1; color:#ffffff" position="0 2 3"></a-entity>
  </a-scene>

  <div class="hint">Abra a m√£o para aparecer a florzinha üå∏</div>

  <script>
    const video = document.getElementById('inputVideo');
    const modelEl = document.getElementById('flower');
    const camEl = document.getElementById('cam');

    // ---- Detector de m√£o aberta (heur√≠stica leve)
    function isHandOpen(landmarks){
      // Considera dedos estendidos comparando pontas (tip) com juntas (pip)
      const FINGERS = [
        {tip:8, pip:6},   // indicador
        {tip:12, pip:10}, // m√©dio
        {tip:16, pip:14}, // anelar
        {tip:20, pip:18}  // m√≠nimo
      ];
      let extended = 0;
      for(const f of FINGERS){
        if(landmarks[f.tip].y < landmarks[f.pip].y) extended++; // y menor = mais alto na imagem
      }
      // Polegar: dist√¢ncia tip(4) at√© base(2) relativamente grande
      const dThumb = Math.hypot(
        landmarks[4].x - landmarks[2].x,
        landmarks[4].y - landmarks[2].y
      );
      const thumbOpen = dThumb > 0.08;
      return extended >= 3 && thumbOpen; // ~m√£o aberta
    }

    // ---- Pega um ponto representativo da palma (m√©dia de alguns pontos)
    function palmCenter(landmarks){
      const idx = [0, 1, 5, 9, 13, 17]; // pontos centrais da palma
      let x=0,y=0;
      idx.forEach(i=>{ x+=landmarks[i].x; y+=landmarks[i].y; });
      x/=idx.length; y/=idx.length;
      return {x, y};
    }

    // ---- Projeta o ponto 2D (0..1) para 3D √† frente da c√¢mera
    function placeAtScreenPoint(nx, ny, distanceMeters=0.6){
      const threeCam = camEl.getObject3D('camera');
      if(!threeCam) return;

      // NDC: (-1..1), invertendo Y pra coords de tela
      const ndcX = nx*2 - 1;
      const ndcY = -(ny*2 - 1);

      const vec = new THREE.Vector3(ndcX, ndcY, 0.5).unproject(threeCam);
      const dir = vec.sub(threeCam.position).normalize();
      const pos = threeCam.position.clone().add(dir.multiplyScalar(distanceMeters));

      modelEl.object3D.position.copy(pos);
    }

    // ---- MediaPipe Hands
    const hands = new Hands({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.6
    });

    hands.onResults(res=>{
      if(res.multiHandLandmarks && res.multiHandLandmarks.length){
        const lm = res.multiHandLandmarks[0];
        const open = isHandOpen(lm);
        modelEl.setAttribute('visible', open);
        if(open){
          const c = palmCenter(lm);     // c.x, c.y normalizados (0..1)
          placeAtScreenPoint(c.x, c.y); // posiciona a flor na palma
        }
      }else{
        modelEl.setAttribute('visible', false);
      }
    });

    // ---- C√¢mera: tenta traseira por deviceId; fallback para facingMode
    async function startCamera(){
      try{
        // Primeiro pede permiss√£o com environment (ativa labels no iOS)
        let stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        video.srcObject = stream;
        await video.play();

        // Tenta achar a c√¢mera "back" e reabrir com deviceId (mais confi√°vel no iOS)
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        const back = cams.find(c=>c.label.toLowerCase().includes('back')) || cams[0];

        if(back){
          const exact = await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact: back.deviceId } }, audio:false });
          video.srcObject = exact; // troca para a traseira garantida
          await video.play();
          stream.getTracks().forEach(t=>t.stop()); // encerra a anterior
          stream = exact;
        }

        // Inicia o loop do MediaPipe
        const cam = new Camera(video, {
          onFrame: async () => { await hands.send({ image: video }); },
          width: 640, height: 480
        });
        cam.start();

        console.log('‚úÖ C√¢mera OK');
      }catch(err){
        console.error('‚ùå Erro c√¢mera:', err);
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do navegador.');
      }
    }

    // Voltar
    document.getElementById('backBtn').addEventListener('click', ()=>{ window.location.href='index.html'; });

    // GO!
    startCamera();
  </script>
</body>
</html>
