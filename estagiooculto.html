<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ðŸŒ¿ Palma AR com CÃ¢mera Estilo Hiro</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

  <style>
    html, body { margin: 0; overflow: hidden; }
    a-scene {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
    }
    /* vÃ­deo processado pelo AR.js (textura otimizada e leve correÃ§Ã£o de cor) */
    #arjs-video {
      filter: brightness(1.1) contrast(1.05) saturate(1.2);
      object-fit: cover;
      transform: scaleX(-1); /* espelha pra parecer cÃ¢mera traseira real */
    }
  </style>
</head>

<body>
  <!-- Cena principal -->
  <a-scene embedded arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
    <a-entity id="model"
      gltf-model="url(assets/florzinha.glb)"
      visible="false"
      position="0 0 -2"
      scale="0.3 0.3 0.3"
      animation-mixer="clip:*; loop: repeat;">
    </a-entity>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // ConfiguraÃ§Ã£o do MediaPipe Hands
    const hands = new Hands({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.6
    });

    const model = document.getElementById('model');
    const video = document.querySelector('video'); // AR.js cria internamente o <video>

    // Aguardar a cÃ¢mera do AR.js inicializar
    video.addEventListener('loadeddata', () => {
      console.log('âœ… CÃ¢mera AR.js pronta');
      processFrames();
    });

    async function processFrames() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      async function loop() {
        // ajusta o canvas pro tamanho do vÃ­deo
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        await hands.send({ image: canvas });
        requestAnimationFrame(loop);
      }

      hands.onResults(results => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
          const hand = results.multiHandLandmarks[0];
          const openPalm =
            hand[8].y < hand[6].y &&
            hand[12].y < hand[10].y &&
            hand[16].y < hand[14].y &&
            hand[20].y < hand[18].y;

          model.setAttribute('visible', openPalm);
        } else {
          model.setAttribute('visible', false);
        }
      });

      loop();
    }
  </script>
</body>
</html>
